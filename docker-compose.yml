# version: "3.9"
# services:
#   mosquitto:
#     image: eclipse-mosquitto:latest
#     container_name: mosquitto
#     restart: unless-stopped
#     ports:
#       - "1883:1883"
#       - "9001:9001"
#     volumes:
#       - ./mosquitto/config:/mosquitto/config
#       - ./mosquitto/data:/mosquitto/data
#       - ./mosquitto/log:/mosquitto/log
#     networks:
#       - iot-net

#   node-red:
#     image: nodered/node-red:latest
#     container_name: node-red
#     restart: unless-stopped
#     ports:
#       - "1881:1880"
#     # volumes:
#     #   - node-red-data:/data
#     #   - ./node-red/flows.json:/data/flows.json:ro
#     depends_on:
#       - mosquitto
#     networks:
#       - iot-net

# networks:
#   iot-net:
#     driver: bridge

# volumes:
#   node-red-data:


#  PHASE 2


version: "3.9"
services:
  mosquitto:
    image: eclipse-mosquitto:latest
    container_name: mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    networks:
      - iot-net

  node-red:
    image: nodered/node-red:latest
    container_name: node-red
    restart: unless-stopped
    ports:
      - "1880:1880"
    # Mount a read-only copy of the initial flows and use a Docker volume for /data.
    # At container start we copy the initial flows into /data to ensure the
    # flows are present on every start but not tied to a host file. Runtime
    # edits will be stored in the Docker volume but are overwritten at startup.
    volumes:
      - ./node-red/flows.json:/tmp/initial_flows.json:ro
      - node-red-data:/data
    command: /bin/sh -c "cp /tmp/initial_flows.json /data/flows.json && node-red -u /data"
    depends_on:
      - mosquitto
    networks:
      - iot-net

  influxdb:
    image: influxdb:2.7
    container_name: influxdb
    restart: unless-stopped
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=admin123
      - DOCKER_INFLUXDB_INIT_ORG=home
      - DOCKER_INFLUXDB_INIT_BUCKET=sensors
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=mysecretlongtoken1234567890
    volumes:
      - influxdb-data:/var/lib/influxdb2
    networks:
      - iot-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/ping"]
      interval: 10s
      retries: 10

  telegraf:
    image: telegraf:1.30-alpine
    container_name: telegraf
    restart: unless-stopped
    depends_on:
      influxdb:
        condition: service_healthy
      mosquitto:
        condition: service_started
    volumes:
      # Mount the telegraf config directory so Docker Desktop on Windows
      # doesn't confuse file vs directory mounts.
      - ./telegraf/telegraf:/etc/telegraf:ro
    environment:
      - INFLUX_TOKEN=mysecretlongtoken1234567890
    command: ["telegraf","--config","/etc/telegraf/telegraf.conf"]
    networks:
      - iot-net

  influx-init:
    image: python:3.11-alpine
    container_name: influx-init
    restart: "no"
    depends_on:
      influxdb:
        condition: service_healthy
    volumes:
      - ./telegraf/telegraf:/etc/telegraf:ro
      - ./influx/register_telegraf.py:/scripts/register_telegraf.py:ro
    environment:
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=mysecretlongtoken1234567890
      - DOCKER_INFLUXDB_INIT_ORG=home
    command: ["python","/scripts/register_telegraf.py"]
    networks:
      - iot-net

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=grafana123
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    depends_on:
      - influxdb
    networks:
      - iot-net

networks:
  iot-net:
    driver: bridge

volumes:
  node-red-data:
  influxdb-data:
  grafana-data: